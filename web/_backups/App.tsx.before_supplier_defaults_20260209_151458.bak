import React, { useEffect, useMemo, useState } from "react";
import GridEditor from "./components/GridEditor";

/* =========================
   Types
========================= */

type MenuKey =
  | "customers_business"
  | "customers_individual"
  | "project_preferences"
  | "address_database"
  | "reports"
  | "cad_drawing"
  | "remote_support";

type ClientType = "Business" | "Individual";
type EstimateStatus = "Draft" | "Completed";

type ProductType =
  | "uPVC"
  | "uPVC Alu Clad"
  | "Timber"
  | "Timber Aluminium Clad"
  | "Aluminium"
  | "Steel";

type View = "customers" | "estimate_defaults" | "estimate_workspace";

type Client = {
  id: string;
  type: ClientType;
  clientRef: string; // EF-CL-001
  clientName: string; // Individual: name, Business: display name (usually business name)
  email: string;
  mobile: string;
  home: string;

  projectName: string;
  projectAddress: string;
  invoiceAddress: string;

  businessName?: string;
  contactPerson?: string;

  estimates: Estimate[];
};

type EstimateDefaults = {
  supplier: string;
  productType: ProductType;
  product: string;

  // your requested defaults/questions
  woodType: string; // only meaningful for timber types
  externalFinish: string;
  internalFinish: string;
  hingeType: "Exposed" | "Concealed";

  glazingBarsRequired: boolean;
  glazingBarOption: string;

  glassType: "Double" | "Triple";
  glassOption: string;
  glassUValue: string;
  glassGValue: string;

  windowHandleType: "Lockable" | "Non-locking";

  doorMultipointLocking: boolean;
  doorHandleExternal: "Lever both sides" | "Pull handle";
  doorPullHandleSizeMm: number;
  doorLeverInternal: boolean;

  cylinderKeyedAlike: boolean;
  cylinderOperation: "Key/Key" | "Thumb turn";

  internalCillRequired: boolean;
  externalSillRequired: boolean;

  frameExtensionMm: number; // 0/25/50/75/100

  sunProtectionRequired: boolean;
  sunProtectionType: string;
};

type Estimate = {
  id: string;
  estimateRef: string;
  baseEstimateRef: string;
  revisionNo: number;
  status: EstimateStatus;

  // NEW: estimate-level defaults screen must be completed/used
  defaults: EstimateDefaults;
  defaultsConfirmed: boolean;

  positions: Position[];
};

type Position = {
  id: string;
  positionRef: string;
  qty: number;
  roomName: string;

  // supplier/product normally inherited from estimate defaults
  supplier: string;
  productType: ProductType;
  product: string;

  // sizing/grid
  widthMm: number;
  heightMm: number;
  fieldsX: number;
  fieldsY: number;
  insertion: string;

  // optional, persisted per position
  colWidthsMm?: number[];
  rowHeightsMm?: number[];

  positionType: "Window" | "Door";

  // the questions/options
  woodType: string;
  externalFinish: string;
  internalFinish: string;
  hingeType: "Exposed" | "Concealed";

  glazingBarsRequired: boolean;
  glazingBarOption: string;

  glassType: "Double" | "Triple";
  glassOption: string;
  glassUValue: string;
  glassGValue: string;

  windowHandleType: "Lockable" | "Non-locking";

  doorMultipointLocking: boolean;
  doorHandleExternal: "Lever both sides" | "Pull handle";
  doorPullHandleSizeMm: number;
  doorLeverInternal: boolean;

  cylinderKeyedAlike: boolean;
  cylinderOperation: "Key/Key" | "Thumb turn";

  internalCillRequired: boolean;
  externalSillRequired: boolean;

  frameExtensionMm: number;

  sunProtectionRequired: boolean;
  sunProtectionType: string;

  // per-position override switch
  overrideDefaults: boolean;
};

/* =========================
   Helpers
========================= */

function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function pad3(n: number) {
  const s = String(n);
  return s.length >= 3 ? s : "0".repeat(3 - s.length) + s;
}

function clampNum(n: number, min: number, max: number) {
  return Math.max(min, Math.min(max, n));
}

function parseNumberLoose(raw: string, prev: number) {
  const s = (raw ?? "").toString().trim();
  if (s === "") return prev;
  const n = Number(s);
  if (!Number.isFinite(n)) return prev;
  return n;
}

function nextClientRef(n: number) {
  return `EF-CL-${pad3(n)}`;
}

function nextEstimateBaseRef(year: number, n: number) {
  return `EF-${year}-${pad3(n)}`;
}

function estimateRefWithRevision(base: string, revisionNo: number) {
  if (revisionNo <= 0) return base;
  return `${base}-${String(revisionNo).padStart(2, "0")}`;
}

/* =========================
   Options (your requested defaults)
========================= */

const PRODUCT_TYPES: ProductType[] = [
  "uPVC",
  "uPVC Alu Clad",
  "Timber",
  "Timber Aluminium Clad",
  "Aluminium",
  "Steel",
];

const WOOD_TYPES = [
  "Finger Jointed Pine",
  "Pine",
  "Spruce",
  "Larch",
  "Oak",
  "Accoya",
  "Meranti",
  "Mahogany",
];

const GLAZING_BAR_OPTIONS = ["Standard", "Slim", "Wide"];

const GLASS_OPTIONS = ["Clear", "Low-E", "Solar control", "Acoustic"];

const SUN_PROTECTION_OPTIONS = [
  "Shutters",
  "Roller blinds",
  "Venetian blinds (external)",
  "Venetian blinds (internal)",
];

const DOOR_PULL_HANDLE_SIZES = [400, 600, 800, 1000, 1200, 2000];

function isTimberProductType(t: ProductType) {
  return t === "Timber" || t === "Timber Aluminium Clad";
}

/* =========================
   Supplier catalog (seed defaults)
========================= */

type SupplierCatalog = {
  name: string;
  productsByType: Partial<Record<ProductType, string[]>>;
};

const SUPPLIERS: SupplierCatalog[] = [
  {
    name: "Internorm",
    productsByType: {
      uPVC: ["KF520", "KF410", "KF320", "KF310"],
      "uPVC Alu Clad": ["KV440", "KV350", "KF520", "KF310", "KF320"],
      "Timber Aluminium Clad": ["HV450", "HF410", "HF510", "HT410", "HT400", "HT310", "HS330"],
      Aluminium: ["AT500", "AT510", "AT520", "AT530", "AT540"],
    },
  },
  {
    name: "Eko Okna",
    productsByType: {
      uPVC: [
        "Synego",
        "Ideal 4000",
        "Ideal 4000 Casement",
        "Ideal 70",
        "EkoSun 70",
        "BluEvolution 82",
        "Ideal 8000",
        "Ideal Neo",
        "GreenEvolution Flex",
        "Energeto Neo",
        "Ideal 4000 (New)",
        "Ideal 5000",
        "Ideal 7000 (New)",
        "Ideal 7000 NL",
        "Energeto 8000",
        "Nordline",
        "BluEvolution 92",
        "EkoSun 6",
        "EkoSun NL",
        "EkoSun 7",
        "S8000",
        "S9000",
      ],
      Timber: ["Esperia Life 80", "Naturo 68", "Naturo 80", "Naturo 92"],
      "Timber Aluminium Clad": ["Esperia Life 74 Alu", "Naturo 68 Alu", "Naturo 80 Alu"],
      Aluminium: [
        "MB-79N",
        "Cortizon Casement",
        "Slimeline 38",
        "MB-86 Casement",
        "MB-79N Casement",
        "MB-45",
        "Masterline 8",
        "VS600",
        "MB-60",
        "MB-104 Passive",
        "MB-Ferroline",
        "Ecofutural",
        "Superial",
        "Genesis",
        "Imperial",
        "MaxLight",
        "Decalu 88 Standard",
        "Decalu 94 Retro",
        "Decalu 100 Steel",
        "Decalu 88 Hidden",
      ],
      Steel: ["Unico XS", "Presto", "Unico XS Casement", "Unico"],
    },
  },
];

function getSupplier(name: string) {
  return SUPPLIERS.find((s) => s.name === name) ?? null;
}

function allProductsForSupplier(name: string) {
  const s = getSupplier(name);
  if (!s) return [];
  const all = Object.values(s.productsByType).flat().filter(Boolean) as string[];
  return Array.from(new Set(all)).sort((a, b) => a.localeCompare(b));
}

function firstProductForSupplier(name: string) {
  return allProductsForSupplier(name)[0] ?? "";
}

function makeDefaultEstimateDefaults(): EstimateDefaults {
  const supplier = SUPPLIERS[0]?.name ?? "";
  const productType: ProductType = "uPVC";
  const product = supplier ? firstProductForSupplier(supplier) : "";
  return {
    supplier,
    productType,
    product,

    woodType: WOOD_TYPES[0],
    externalFinish: "",
    internalFinish: "",
    hingeType: "Concealed",

    glazingBarsRequired: false,
    glazingBarOption: GLAZING_BAR_OPTIONS[0],

    glassType: "Double",
    glassOption: GLASS_OPTIONS[0],
    glassUValue: "",
    glassGValue: "",

    windowHandleType: "Lockable",

    doorMultipointLocking: true,
    doorHandleExternal: "Lever both sides",
    doorPullHandleSizeMm: DOOR_PULL_HANDLE_SIZES[0],
    doorLeverInternal: true,

    cylinderKeyedAlike: false,
    cylinderOperation: "Key/Key",

    internalCillRequired: false,
    externalSillRequired: false,

    frameExtensionMm: 0,

    sunProtectionRequired: false,
    sunProtectionType: SUN_PROTECTION_OPTIONS[0],
  };
}

function makePositionFromDefaults(nextIndex: number, defaults: EstimateDefaults): Position {
  return {
    id: uid(),
    positionRef: `W-${pad3(nextIndex)}`,
    qty: 1,
    roomName: "",

    supplier: defaults.supplier,
    productType: defaults.productType,
    product: defaults.product,

    widthMm: 1000,
    heightMm: 1200,
    fieldsX: 1,
    fieldsY: 1,
    insertion: "Fixed",
    colWidthsMm: undefined,
    rowHeightsMm: undefined,

    positionType: "Window",

    woodType: defaults.woodType,
    externalFinish: defaults.externalFinish,
    internalFinish: defaults.internalFinish,
    hingeType: defaults.hingeType,

    glazingBarsRequired: defaults.glazingBarsRequired,
    glazingBarOption: defaults.glazingBarOption,

    glassType: defaults.glassType,
    glassOption: defaults.glassOption,
    glassUValue: defaults.glassUValue,
    glassGValue: defaults.glassGValue,

    windowHandleType: defaults.windowHandleType,

    doorMultipointLocking: defaults.doorMultipointLocking,
    doorHandleExternal: defaults.doorHandleExternal,
    doorPullHandleSizeMm: defaults.doorPullHandleSizeMm,
    doorLeverInternal: defaults.doorLeverInternal,

    cylinderKeyedAlike: defaults.cylinderKeyedAlike,
    cylinderOperation: defaults.cylinderOperation,

    internalCillRequired: defaults.internalCillRequired,
    externalSillRequired: defaults.externalSillRequired,

    frameExtensionMm: defaults.frameExtensionMm,

    sunProtectionRequired: defaults.sunProtectionRequired,
    sunProtectionType: defaults.sunProtectionType,

    overrideDefaults: false,
  };
}

/* =========================
   Seed clients
========================= */

const DEFAULT_CUSTOMER_ADDRESS = ["4 Glebe Road", "Cowdenbeath", "Fife", "KY4 9FA"].join("\n");

function makeDefaultClients(): Client[] {
  return [
    {
      id: uid(),
      type: "Business",
      clientRef: nextClientRef(1),
      clientName: "Ecofenster Ltd",
      businessName: "Ecofenster Ltd",
      contactPerson: "",
      email: "",
      mobile: "07882 809 453",
      home: "",
      projectName: "",
      projectAddress: DEFAULT_CUSTOMER_ADDRESS,
      invoiceAddress: DEFAULT_CUSTOMER_ADDRESS,
      estimates: [],
    },
    {
      id: uid(),
      type: "Individual",
      clientRef: nextClientRef(2),
      clientName: "Craig Ferguson",
      businessName: "",
      contactPerson: "",
      email: "",
      mobile: "07882 809 453",
      home: "",
      projectName: "",
      projectAddress: DEFAULT_CUSTOMER_ADDRESS,
      invoiceAddress: DEFAULT_CUSTOMER_ADDRESS,
      estimates: [],
    },
  ];
}

/* =========================
   UI primitives
========================= */

function Card({ children, style }: { children: React.ReactNode; style?: React.CSSProperties }) {
  return (
    <div
      style={{
        borderRadius: 18,
        border: "1px solid #e4e4e7",
        background: "#fff",
        padding: 16,
        boxShadow: "0 1px 2px rgba(0,0,0,.06)",
        ...style,
      }}
    >
      {children}
    </div>
  );
}

function H2({ children }: { children: React.ReactNode }) {
  return <h2 style={{ fontSize: 16, margin: 0, fontWeight: 800, color: "#18181b" }}>{children}</h2>;
}

function H3({ children }: { children: React.ReactNode }) {
  return <h3 style={{ fontSize: 14, margin: 0, fontWeight: 800, color: "#18181b" }}>{children}</h3>;
}

function Small({ children }: { children: React.ReactNode }) {
  return <div style={{ fontSize: 12, color: "#71717a" }}>{children}</div>;
}

function Button({
  children,
  onClick,
  variant = "primary",
  disabled,
  style,
}: {
  children: React.ReactNode;
  onClick?: () => void;
  variant?: "primary" | "secondary";
  disabled?: boolean;
  style?: React.CSSProperties;
}) {
  const isPrimary = variant === "primary";
  return (
    <button
      type="button"
      disabled={!!disabled}
      onClick={onClick}
      style={{
        borderRadius: 18,
        border: isPrimary ? "none" : "1px solid #e4e4e7",
        background: isPrimary ? "#18181b" : "#fff",
        color: isPrimary ? "#fff" : "#3f3f46",
        padding: "10px 14px",
        fontSize: 14,
        fontWeight: 800,
        cursor: disabled ? "not-allowed" : "pointer",
        opacity: disabled ? 0.55 : 1,
        ...style,
      }}
    >
      {children}
    </button>
  );
}

function Input({
  value,
  onChange,
  placeholder,
  type = "text",
}: {
  value: string;
  onChange: (v: string) => void;
  placeholder?: string;
  type?: string;
}) {
  return (
    <input
      type={type}
      value={value}
      placeholder={placeholder}
      onChange={(e) => onChange(e.target.value)}
      style={{
        width: "100%",
        borderRadius: 12,
        border: "1px solid #e4e4e7",
        padding: "10px 12px",
        fontSize: 14,
        outline: "none",
      }}
    />
  );
}

function Pill({ children }: { children: React.ReactNode }) {
  return (
    <span
      style={{
        display: "inline-flex",
        alignItems: "center",
        borderRadius: 999,
        padding: "4px 10px",
        fontSize: 12,
        fontWeight: 800,
        background: "#f4f4f5",
        color: "#18181b",
        border: "1px solid #e4e4e7",
      }}
    >
      {children}
    </span>
  );
}

const labelStyle: React.CSSProperties = { fontSize: 13, color: "#3f3f46", fontWeight: 700, marginBottom: 6 };

function SidebarItem({
  label,
  active,
  onClick,
}: {
  label: string;
  active?: boolean;
  onClick?: () => void;
}) {
  return (
    <div
      onClick={onClick}
      style={{
        borderRadius: 14,
        padding: "10px 12px",
        marginBottom: 6,
        cursor: "pointer",
        background: active ? "#18181b" : "transparent",
        color: active ? "#fff" : "#3f3f46",
        fontSize: 14,
        fontWeight: active ? 800 : 600,
      }}
    >
      {label}
    </div>
  );
}

/* =========================
   App
========================= */

export default function App() {
  const [menu, setMenu] = useState<MenuKey>("customers_business");
  const [view, setView] = useState<View>("customers");

  const [clientCounter, setClientCounter] = useState(3);
  const [estimateCounter, setEstimateCounter] = useState(1);

  const [clients, setClients] = useState<Client[]>(() => makeDefaultClients());

  const [selectedClientId, setSelectedClientId] = useState<string | null>(null);
  const selectedClient = useMemo(
    () => clients.find((c) => c.id === selectedClientId) ?? null,
    [clients, selectedClientId]
  );

  const [selectedEstimateId, setSelectedEstimateId] = useState<string | null>(null);
  const selectedEstimate = useMemo(() => {
    if (!selectedClient) return null;
    return selectedClient.estimates.find((e) => e.id === selectedEstimateId) ?? null;
  }, [selectedClient, selectedEstimateId]);

  // estimate picker modal (when client has multiple estimates)
  const [estimatePickerClientId, setEstimatePickerClientId] = useState<string | null>(null);
  const estimatePickerClient = useMemo(
    () => clients.find((c) => c.id === estimatePickerClientId) ?? null,
    [clients, estimatePickerClientId]
  );

  // Defaults screen draft (bound to selected estimate)
  const [defaultsDraft, setDefaultsDraft] = useState<EstimateDefaults>(() => makeDefaultEstimateDefaults());

  // Position wizard
  const [showPositionWizard, setShowPositionWizard] = useState(false);
  const [posStep, setPosStep] = useState<1 | 2 | 3>(1); // 1 position, 2 dims, 3 config
  const [posDraft, setPosDraft] = useState<Position | null>(null);

  // Derived for customer lists
  const activeClientType: ClientType = menu === "customers_business" ? "Business" : "Individual";
  const filteredClients = useMemo(
    () => clients.filter((c) => c.type === activeClientType),
    [clients, activeClientType]
  );

  function selectMenu(k: MenuKey) {
    setMenu(k);
    setView("customers");
    setSelectedClientId(null);
    setSelectedEstimateId(null);
    setEstimatePickerClientId(null);
    setShowPositionWizard(false);
  }

  function openEstimateDefaults(clientId: string, estimateId: string) {
    setSelectedClientId(clientId);
    setSelectedEstimateId(estimateId);
    setShowPositionWizard(false);
    setView("estimate_defaults");
  }

  function openWorkspace(clientId: string, estimateId: string) {
    setSelectedClientId(clientId);
    setSelectedEstimateId(estimateId);
    setShowPositionWizard(false);
    setView("estimate_workspace");
  }

  function createEstimateForClient(client: Client) {
    const year = new Date().getFullYear();
    const base = nextEstimateBaseRef(year, estimateCounter);

    const est: Estimate = {
      id: uid(),
      estimateRef: base,
      baseEstimateRef: base,
      revisionNo: 0,
      status: "Draft",
      defaults: makeDefaultEstimateDefaults(),
      defaultsConfirmed: false,
      positions: [],
    };

    setEstimateCounter((n) => n + 1);

    setClients((prev) =>
      prev.map((c) => (c.id === client.id ? { ...c, estimates: [est, ...c.estimates] } : c))
    );

    // Immediately go to Supplier & Product defaults screen (your requirement)
    openEstimateDefaults(client.id, est.id);
  }

  // Client Open behavior:
  // - 0 estimates => create new estimate -> defaults screen
  // - 1 estimate => defaults screen for that estimate
  // - 2+ estimates => show list modal
  function openClientOrShowEstimateList(client: Client) {
    if (client.estimates.length === 0) {
      createEstimateForClient(client);
      return;
    }
    if (client.estimates.length === 1) {
      openEstimateDefaults(client.id, client.estimates[0].id);
      return;
    }
    setEstimatePickerClientId(client.id);
  }

  // keep defaultsDraft in sync when selected estimate changes
  useEffect(() => {
    if (!selectedEstimate) return;
    setDefaultsDraft(selectedEstimate.defaults);
  }, [selectedEstimateId]);

  function saveDefaultsAndContinue() {
    if (!selectedClient || !selectedEstimate) return;

    setClients((prev) =>
      prev.map((c) => {
        if (c.id !== selectedClient.id) return c;
        return {
          ...c,
          estimates: c.estimates.map((e) => {
            if (e.id !== selectedEstimate.id) return e;
            return { ...e, defaults: defaultsDraft, defaultsConfirmed: true };
          }),
        };
      })
    );

    openWorkspace(selectedClient.id, selectedEstimate.id);
  }

  function startAddPosition() {
    if (!selectedClient || !selectedEstimate) return;

    const nextIndex = (selectedEstimate.positions?.length ?? 0) + 1;
    const base = makePositionFromDefaults(nextIndex, selectedEstimate.defaults);

    setPosDraft(base);
    setPosStep(1);
    setShowPositionWizard(true);
  }

  function savePositionToEstimate() {
    if (!selectedClient || !selectedEstimate || !posDraft) return;

    const cleaned: Position = {
      ...posDraft,
      id: uid(),
      widthMm: clampNum(Math.round(posDraft.widthMm || 0), 300, 6000),
      heightMm: clampNum(Math.round(posDraft.heightMm || 0), 300, 6000),
      fieldsX: clampNum(Math.round(posDraft.fieldsX || 1), 1, 16),
      fieldsY: clampNum(Math.round(posDraft.fieldsY || 1), 1, 16),
    };

    setClients((prev) =>
      prev.map((c) => {
        if (c.id !== selectedClient.id) return c;
        return {
          ...c,
          estimates: c.estimates.map((e) => {
            if (e.id !== selectedEstimate.id) return e;
            return { ...e, positions: [cleaned, ...e.positions] };
          }),
        };
      })
    );

    setShowPositionWizard(false);
    setPosDraft(null);
    setPosStep(1);
  }

  // Apply estimate defaults into position when override is off
  useEffect(() => {
    if (!selectedEstimate) return;
    if (!posDraft) return;
    if (posDraft.overrideDefaults) return;

    const d = selectedEstimate.defaults;
    setPosDraft((p) =>
      p
        ? {
            ...p,
            supplier: d.supplier,
            productType: d.productType,
            product: d.product,
            woodType: d.woodType,
            externalFinish: d.externalFinish,
            internalFinish: d.internalFinish,
            hingeType: d.hingeType,
            glazingBarsRequired: d.glazingBarsRequired,
            glazingBarOption: d.glazingBarOption,
            glassType: d.glassType,
            glassOption: d.glassOption,
            glassUValue: d.glassUValue,
            glassGValue: d.glassGValue,
            windowHandleType: d.windowHandleType,
            doorMultipointLocking: d.doorMultipointLocking,
            doorHandleExternal: d.doorHandleExternal,
            doorPullHandleSizeMm: d.doorPullHandleSizeMm,
            doorLeverInternal: d.doorLeverInternal,
            cylinderKeyedAlike: d.cylinderKeyedAlike,
            cylinderOperation: d.cylinderOperation,
            internalCillRequired: d.internalCillRequired,
            externalSillRequired: d.externalSillRequired,
            frameExtensionMm: d.frameExtensionMm,
            sunProtectionRequired: d.sunProtectionRequired,
            sunProtectionType: d.sunProtectionType,
          }
        : p
    );
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedEstimateId, posDraft?.overrideDefaults]);

  return (
    <div style={{ fontFamily: "system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif", background: "#f4f4f5", minHeight: "100vh" }}>
      <div style={{ width: "100%", margin: "0", padding: 16 }}>
        <div style={{ display: "grid", gridTemplateColumns: "280px 1fr", gap: 16 }}>
          {/* Sidebar */}
          <Card style={{ padding: 12 }}>
            <div style={{ padding: "6px 6px 12px 6px" }}>
              <img
                src="/quotesync-logo.png"
                alt="QuoteSync"
                style={{ width: "100%", maxWidth: 260, height: 78, objectFit: "contain", display: "block" }}
              />
            </div>

            <div style={{ marginTop: 14 }}>
              <H3>Customers</H3>
              <div style={{ marginTop: 8 }}>
                <SidebarItem label="Business Customers" active={menu === "customers_business"} onClick={() => selectMenu("customers_business")} />
                <SidebarItem label="Individual Customers" active={menu === "customers_individual"} onClick={() => selectMenu("customers_individual")} />
              </div>
            </div>

            <div style={{ marginTop: 14 }}>
              <H3>Preferences</H3>
              <div style={{ marginTop: 8 }}>
                <SidebarItem label="Project Preferences" active={menu === "project_preferences"} onClick={() => selectMenu("project_preferences")} />
                <SidebarItem label="Address Database" active={menu === "address_database"} onClick={() => selectMenu("address_database")} />
              </div>
            </div>

            <div style={{ marginTop: 14 }}>
              <H3>Tools</H3>
              <div style={{ marginTop: 8 }}>
                <SidebarItem label="Reports" active={menu === "reports"} onClick={() => selectMenu("reports")} />
                <SidebarItem label="CAD Drawing" active={menu === "cad_drawing"} onClick={() => selectMenu("cad_drawing")} />
                <SidebarItem label="Remote Support" active={menu === "remote_support"} onClick={() => selectMenu("remote_support")} />
              </div>
            </div>
          </Card>

          {/* Main */}
          <div style={{ display: "grid", gap: 16 }}>
            {/* Customers */}
            {(menu === "customers_business" || menu === "customers_individual") && view === "customers" && (
              <Card style={{ minHeight: 520 }}>
                <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 12 }}>
                  <div>
                    <H2>{menu === "customers_business" ? "Business Customers" : "Individual Customers"}</H2>
                    <Small>Open a client to pick an estimate, or start a new one.</Small>
                  </div>
                </div>

                <div style={{ marginTop: 12, display: "grid", gap: 12 }}>
                  {filteredClients.length === 0 && <div style={{ fontSize: 13, color: "#71717a" }}>No clients yet.</div>}

                  {filteredClients.map((c) => (
                    <div
                      key={c.id}
                      style={{
                        borderRadius: 16,
                        border: "1px solid #e4e4e7",
                        padding: 12,
                        background: "#fff",
                        display: "grid",
                        gap: 8,
                      }}
                    >
                      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 10 }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
                          <H3>{c.clientName}</H3>
                          <Pill>{c.clientRef}</Pill>
                          <Pill>{c.estimates.length} estimates</Pill>
                        </div>

                        <div style={{ display: "flex", gap: 10 }}>
                          <Button variant="primary" onClick={() => openClientOrShowEstimateList(c)}>
                            Open
                          </Button>
                          <Button variant="secondary" onClick={() => createEstimateForClient(c)}>
                            New Estimate
                          </Button>
                        </div>
                      </div>

                      <div style={{ fontSize: 12, color: "#71717a" }}>
                        {c.projectName || "No project name"} • {c.projectAddress ? c.projectAddress.split("\n")[0] : "No project address"}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Estimate picker modal */}
                {estimatePickerClient && (
                  <div
                    style={{
                      position: "fixed",
                      inset: 0,
                      background: "rgba(0,0,0,.35)",
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      padding: 16,
                      zIndex: 50,
                    }}
                    onClick={() => setEstimatePickerClientId(null)}
                  >
                    <div
                      style={{
                        width: "min(720px, 100%)",
                        borderRadius: 18,
                        background: "#fff",
                        border: "1px solid #e4e4e7",
                        padding: 14,
                      }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", gap: 10 }}>
                        <div>
                          <H2>Select an estimate</H2>
                          <Small>{estimatePickerClient.clientName} • {estimatePickerClient.clientRef}</Small>
                        </div>
                        <Button variant="secondary" onClick={() => setEstimatePickerClientId(null)}>
                          Close
                        </Button>
                      </div>

                      <div style={{ marginTop: 12, display: "grid", gap: 10 }}>
                        {estimatePickerClient.estimates.map((e) => (
                          <div
                            key={e.id}
                            style={{
                              borderRadius: 14,
                              border: "1px solid #e4e4e7",
                              padding: 10,
                              display: "flex",
                              alignItems: "center",
                              justifyContent: "space-between",
                              gap: 10,
                            }}
                          >
                            <div style={{ display: "flex", alignItems: "center", gap: 10, flexWrap: "wrap" }}>
                              <Pill>{e.estimateRef}</Pill>
                              <Pill>{e.status}</Pill>
                              <Small>{e.defaultsConfirmed ? "Defaults: set" : "Defaults: not set"}</Small>
                            </div>
                            <Button
                              variant="primary"
                              onClick={() => {
                                setEstimatePickerClientId(null);
                                openEstimateDefaults(estimatePickerClient.id, e.id);
                              }}
                            >
                              Open
                            </Button>
                          </div>
                        ))}
                      </div>

                      <div style={{ marginTop: 12, display: "flex", justifyContent: "flex-end", gap: 10 }}>
                        <Button variant="primary" onClick={() => { setEstimatePickerClientId(null); createEstimateForClient(estimatePickerClient); }}>
                          New Estimate
                        </Button>
                      </div>
                    </div>
                  </div>
                )}
              </Card>
            )}

            {/* Estimate defaults screen (Supplier & Product + ALL questions) */}
            {(menu === "customers_business" || menu === "customers_individual") &&
              view === "estimate_defaults" &&
              selectedClient &&
              selectedEstimate && (
                <Card style={{ minHeight: 520, display: "grid", gap: 14 }}>
                  <div style={{ display: "flex", justifyContent: "space-between", gap: 12, flexWrap: "wrap" }}>
                    <div>
                      <H2>Supplier & Product Defaults</H2>
                      <Small>
                        {selectedClient.clientName} • {selectedClient.clientRef} • <b>{selectedEstimate.estimateRef}</b>
                      </Small>
                    </div>
                    <div style={{ display: "flex", gap: 10 }}>
                      <Button variant="secondary" onClick={() => setView("customers")}>
                        Back
                      </Button>
                      <Button variant="primary" onClick={saveDefaultsAndContinue}>
                        Continue to Positions
                      </Button>
                    </div>
                  </div>

                  <div style={{ borderRadius: 16, border: "1px solid #e4e4e7", padding: 12 }}>
                    <H3>Supplier / Product</H3>
                    <div style={{ marginTop: 10, display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
                      <div>
                        <div style={labelStyle}>Supplier</div>
                        <select
                          value={defaultsDraft.supplier}
                          onChange={(e) => {
                            const supplier = e.target.value;
                            setDefaultsDraft((d) => ({
                              ...d,
                              supplier,
                              product: supplier ? firstProductForSupplier(supplier) : "",
                            }));
                          }}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="">Select supplier…</option>
                          {SUPPLIERS.map((s) => (
                            <option key={s.name} value={s.name}>
                              {s.name}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <div style={labelStyle}>Product type</div>
                        <select
                          value={defaultsDraft.productType}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, productType: e.target.value as ProductType }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          {PRODUCT_TYPES.map((t) => (
                            <option key={t} value={t}>
                              {t}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <div style={labelStyle}>Product</div>
                        <select
                          value={defaultsDraft.product}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, product: e.target.value }))}
                          disabled={!defaultsDraft.supplier}
                          style={{
                            width: "100%",
                            borderRadius: 12,
                            border: "1px solid #e4e4e7",
                            padding: "10px 12px",
                            fontSize: 14,
                            background: !defaultsDraft.supplier ? "#fafafa" : "#fff",
                            color: !defaultsDraft.supplier ? "#a1a1aa" : "#18181b",
                          }}
                        >
                          <option value="">{defaultsDraft.supplier ? "Select product…" : "Select supplier first…"}</option>
                          {allProductsForSupplier(defaultsDraft.supplier).map((p) => (
                            <option key={p} value={p}>
                              {p}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>

                    <div style={{ marginTop: 10, fontSize: 12, color: "#71717a" }}>
                      These defaults apply to all new positions (you can still override per position).
                    </div>
                  </div>

                  {/* The full list of questions requested */}
                  <div style={{ borderRadius: 16, border: "1px solid #e4e4e7", padding: 12 }}>
                    <H3>Defaults for all items</H3>

                    <div style={{ marginTop: 10, display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                      {/* Wood type only relevant if timber */}
                      <div style={{ gridColumn: "1 / -1" }}>
                        <div style={labelStyle}>Wood type (Timber / Timber Aluminium Clad)</div>
                        <select
                          value={defaultsDraft.woodType}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, woodType: e.target.value }))}
                          disabled={!isTimberProductType(defaultsDraft.productType)}
                          style={{
                            width: "100%",
                            borderRadius: 12,
                            border: "1px solid #e4e4e7",
                            padding: "10px 12px",
                            fontSize: 14,
                            background: !isTimberProductType(defaultsDraft.productType) ? "#fafafa" : "#fff",
                            color: !isTimberProductType(defaultsDraft.productType) ? "#a1a1aa" : "#18181b",
                          }}
                        >
                          {WOOD_TYPES.map((w) => (
                            <option key={w} value={w}>
                              {w}
                            </option>
                          ))}
                        </select>
                        {!isTimberProductType(defaultsDraft.productType) && (
                          <div style={{ marginTop: 6, fontSize: 12, color: "#71717a" }}>
                            Set Product type to Timber / Timber Aluminium Clad to enable.
                          </div>
                        )}
                      </div>

                      <div>
                        <div style={labelStyle}>External finish</div>
                        <Input value={defaultsDraft.externalFinish} onChange={(v) => setDefaultsDraft((d) => ({ ...d, externalFinish: v }))} />
                      </div>

                      <div>
                        <div style={labelStyle}>Internal finish</div>
                        <Input value={defaultsDraft.internalFinish} onChange={(v) => setDefaultsDraft((d) => ({ ...d, internalFinish: v }))} />
                      </div>

                      <div>
                        <div style={labelStyle}>Hinges</div>
                        <select
                          value={defaultsDraft.hingeType}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, hingeType: e.target.value as any }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="Concealed">Concealed</option>
                          <option value="Exposed">Exposed</option>
                        </select>
                      </div>

                      <div />

                      <div style={{ gridColumn: "1 / -1", borderTop: "1px solid #e4e4e7", paddingTop: 12 }}>
                        <H3>Glazing</H3>
                      </div>

                      <div style={{ gridColumn: "1 / -1" }}>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.glazingBarsRequired}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, glazingBarsRequired: e.target.checked }))}
                          />
                          Glazing bars required
                        </label>
                      </div>

                      {defaultsDraft.glazingBarsRequired && (
                        <div>
                          <div style={labelStyle}>Glazing bar option</div>
                          <select
                            value={defaultsDraft.glazingBarOption}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, glazingBarOption: e.target.value }))}
                            style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                          >
                            {GLAZING_BAR_OPTIONS.map((o) => (
                              <option key={o} value={o}>
                                {o}
                              </option>
                            ))}
                          </select>
                        </div>
                      )}

                      <div>
                        <div style={labelStyle}>Glass type</div>
                        <select
                          value={defaultsDraft.glassType}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, glassType: e.target.value as any }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="Double">Double</option>
                          <option value="Triple">Triple</option>
                        </select>
                      </div>

                      <div>
                        <div style={labelStyle}>Glass option</div>
                        <select
                          value={defaultsDraft.glassOption}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, glassOption: e.target.value }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          {GLASS_OPTIONS.map((o) => (
                            <option key={o} value={o}>
                              {o}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <div style={labelStyle}>U value</div>
                        <Input value={defaultsDraft.glassUValue} onChange={(v) => setDefaultsDraft((d) => ({ ...d, glassUValue: v }))} />
                      </div>

                      <div>
                        <div style={labelStyle}>G value</div>
                        <Input value={defaultsDraft.glassGValue} onChange={(v) => setDefaultsDraft((d) => ({ ...d, glassGValue: v }))} />
                      </div>

                      <div style={{ gridColumn: "1 / -1", borderTop: "1px solid #e4e4e7", paddingTop: 12 }}>
                        <H3>Window & Door Hardware</H3>
                      </div>

                      <div>
                        <div style={labelStyle}>Window handle</div>
                        <select
                          value={defaultsDraft.windowHandleType}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, windowHandleType: e.target.value as any }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="Lockable">Lockable</option>
                          <option value="Non-locking">Non-locking</option>
                        </select>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700, marginTop: 20 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.doorMultipointLocking}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, doorMultipointLocking: e.target.checked }))}
                          />
                          Door multipoint locking
                        </label>
                      </div>

                      <div>
                        <div style={labelStyle}>Door external handle</div>
                        <select
                          value={defaultsDraft.doorHandleExternal}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, doorHandleExternal: e.target.value as any }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="Lever both sides">Lever handle both sides</option>
                          <option value="Pull handle">Pull handle</option>
                        </select>
                      </div>

                      <div>
                        <div style={labelStyle}>Pull handle size (mm)</div>
                        <select
                          value={String(defaultsDraft.doorPullHandleSizeMm)}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, doorPullHandleSizeMm: Number(e.target.value) }))}
                          disabled={defaultsDraft.doorHandleExternal !== "Pull handle"}
                          style={{
                            width: "100%",
                            borderRadius: 12,
                            border: "1px solid #e4e4e7",
                            padding: "10px 12px",
                            fontSize: 14,
                            background: defaultsDraft.doorHandleExternal !== "Pull handle" ? "#fafafa" : "#fff",
                            color: defaultsDraft.doorHandleExternal !== "Pull handle" ? "#a1a1aa" : "#18181b",
                          }}
                        >
                          {DOOR_PULL_HANDLE_SIZES.map((s) => (
                            <option key={s} value={s}>
                              {s}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700, marginTop: 20 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.doorLeverInternal}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, doorLeverInternal: e.target.checked }))}
                          />
                          Door lever internal
                        </label>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700, marginTop: 20 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.cylinderKeyedAlike}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, cylinderKeyedAlike: e.target.checked }))}
                          />
                          Cylinder keyed alike
                        </label>
                      </div>

                      <div>
                        <div style={labelStyle}>Cylinder operation</div>
                        <select
                          value={defaultsDraft.cylinderOperation}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, cylinderOperation: e.target.value as any }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          <option value="Key/Key">Key inside and out</option>
                          <option value="Thumb turn">Thumb turn internally</option>
                        </select>
                      </div>

                      <div style={{ gridColumn: "1 / -1", borderTop: "1px solid #e4e4e7", paddingTop: 12 }}>
                        <H3>Accessories</H3>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.internalCillRequired}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, internalCillRequired: e.target.checked }))}
                          />
                          Window cill internally required
                        </label>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.externalSillRequired}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, externalSillRequired: e.target.checked }))}
                          />
                          Window sill externally required
                        </label>
                      </div>

                      <div>
                        <div style={labelStyle}>Frame extensions (mm)</div>
                        <select
                          value={String(defaultsDraft.frameExtensionMm)}
                          onChange={(e) => setDefaultsDraft((d) => ({ ...d, frameExtensionMm: Number(e.target.value) }))}
                          style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                        >
                          {[0, 25, 50, 75, 100].map((v) => (
                            <option key={v} value={v}>
                              {v === 0 ? "None" : v}
                            </option>
                          ))}
                        </select>
                      </div>

                      <div>
                        <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 700, marginTop: 20 }}>
                          <input
                            type="checkbox"
                            checked={defaultsDraft.sunProtectionRequired}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, sunProtectionRequired: e.target.checked }))}
                          />
                          Sun protection required
                        </label>
                      </div>

                      {defaultsDraft.sunProtectionRequired && (
                        <div style={{ gridColumn: "1 / -1" }}>
                          <div style={labelStyle}>Sun protection type</div>
                          <select
                            value={defaultsDraft.sunProtectionType}
                            onChange={(e) => setDefaultsDraft((d) => ({ ...d, sunProtectionType: e.target.value }))}
                            style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                          >
                            {SUN_PROTECTION_OPTIONS.map((o) => (
                              <option key={o} value={o}>
                                {o}
                              </option>
                            ))}
                          </select>
                        </div>
                      )}
                    </div>
                  </div>

                  <div style={{ display: "flex", justifyContent: "space-between", gap: 10, flexWrap: "wrap" }}>
                    <Small>
                      Next: you’ll add positions. New positions inherit these defaults automatically. Use “Override defaults” on a position if needed.
                    </Small>
                    <div style={{ display: "flex", gap: 10 }}>
                      <Button variant="secondary" onClick={() => setView("customers")}>Back</Button>
                      <Button variant="primary" onClick={saveDefaultsAndContinue}>Continue to Positions</Button>
                    </div>
                  </div>
                </Card>
              )}

            {/* Estimate workspace (positions) */}
            {(menu === "customers_business" || menu === "customers_individual") &&
              view === "estimate_workspace" &&
              selectedClient &&
              selectedEstimate && (
                <Card style={{ minHeight: 520, display: "flex", flexDirection: "column" }}>
                  <div style={{ display: "flex", alignItems: "flex-start", justifyContent: "space-between", gap: 12, flexWrap: "wrap" }}>
                    <div>
                      <H2>Estimate</H2>
                      <div style={{ marginTop: 8, display: "flex", gap: 8, flexWrap: "wrap", alignItems: "center" }}>
                        <Pill>{selectedClient.clientRef}</Pill>
                        <Pill>{selectedEstimate.estimateRef}</Pill>
                        <Pill>{selectedEstimate.defaultsConfirmed ? "Defaults set" : "Defaults not set"}</Pill>
                        <Small>{selectedClient.clientName}</Small>
                      </div>
                    </div>

                    <div style={{ display: "flex", gap: 10 }}>
                      <Button variant="secondary" onClick={() => setView("customers")}>Back</Button>
                      <Button variant="secondary" onClick={() => openEstimateDefaults(selectedClient.id, selectedEstimate.id)}>
                        Edit Defaults
                      </Button>
                    </div>
                  </div>

                  {!selectedEstimate.defaultsConfirmed && (
                    <div style={{ marginTop: 12, borderRadius: 14, border: "1px solid #f59e0b", background: "#fffbeb", padding: 12 }}>
                      <div style={{ fontWeight: 900, color: "#92400e" }}>Defaults not set</div>
                      <div style={{ fontSize: 13, color: "#92400e", marginTop: 4 }}>
                        You need to confirm Supplier & Product Defaults before adding positions.
                      </div>
                      <div style={{ marginTop: 10 }}>
                        <Button variant="primary" onClick={() => openEstimateDefaults(selectedClient.id, selectedEstimate.id)}>
                          Go to Defaults
                        </Button>
                      </div>
                    </div>
                  )}

                  <div style={{ marginTop: 16 }}>
                    <Button
                      variant="primary"
                      onClick={startAddPosition}
                      style={{ width: "100%" }}
                      disabled={!selectedEstimate.defaultsConfirmed}
                    >
                      Add Position
                    </Button>
                  </div>

                  <div style={{ marginTop: 16, borderTop: "1px solid #e4e4e7", paddingTop: 12, flex: 1 }}>
                    <H3>Positions</H3>
                    <Small>Positions added to this estimate appear below.</Small>

                    <div style={{ marginTop: 10, display: "grid", gap: 10 }}>
                      {selectedEstimate.positions.length === 0 && (
                        <div style={{ fontSize: 13, color: "#71717a" }}>No positions yet.</div>
                      )}

                      {selectedEstimate.positions.map((p) => (
                        <div key={p.id} style={{ borderRadius: 14, border: "1px solid #e4e4e7", padding: 10, background: "#fff" }}>
                          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 10 }}>
                            <div style={{ fontWeight: 900, fontSize: 13 }}>{p.positionRef}</div>
                            <div style={{ fontSize: 12, color: "#71717a" }}>
                              Qty {p.qty} • {p.widthMm}×{p.heightMm} • {p.fieldsX}×{p.fieldsY}
                            </div>
                          </div>
                          <div style={{ marginTop: 4, fontSize: 12, color: "#71717a" }}>
                            {p.roomName || "—"} • {p.supplier || "—"} • {p.productType || "—"} / {p.product || "—"}
                          </div>
                          {p.overrideDefaults && (
                            <div style={{ marginTop: 6, fontSize: 12, color: "#0f766e" }}>
                              Overrides enabled for this position
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Position wizard */}
                  {showPositionWizard && posDraft && (
                    <div style={{ marginTop: 14, borderRadius: 14, border: "1px solid #e4e4e7", padding: 12, background: "#fff" }}>
                      <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", gap: 10 }}>
                        <H3>Add Position</H3>
                        <Button variant="secondary" onClick={() => { setShowPositionWizard(false); setPosDraft(null); }} style={{ borderRadius: 14, padding: "8px 10px" }}>
                          Close
                        </Button>
                      </div>

                      <div style={{ marginTop: 10, display: "flex", gap: 8, flexWrap: "wrap" }}>
                        {[1, 2, 3].map((s) => (
                          <div
                            key={s}
                            style={{
                              borderRadius: 14,
                              border: "1px solid " + (posStep === s ? "#18181b" : "#e4e4e7"),
                              background: posStep === s ? "#18181b" : "#fff",
                              color: posStep === s ? "#fff" : "#3f3f46",
                              padding: "8px 10px",
                              fontSize: 14,
                              fontWeight: 800,
                            }}
                          >
                            {s}. {s === 1 ? "Position" : s === 2 ? "Dimensions" : "Configuration"}
                          </div>
                        ))}
                      </div>

                      <div style={{ marginTop: 12, borderRadius: 14, border: "1px solid #e4e4e7", padding: 12 }}>
                        {posStep === 1 && (
                          <div style={{ display: "grid", gap: 12 }}>
                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                              <div>
                                <div style={labelStyle}>Position reference</div>
                                <Input value={posDraft.positionRef} onChange={(v) => setPosDraft((p) => (p ? { ...p, positionRef: v } : p))} />
                              </div>
                              <div>
                                <div style={labelStyle}>Quantity</div>
                                <Input
                                  type="number"
                                  value={String(posDraft.qty)}
                                  onChange={(v) => setPosDraft((p) => (p ? { ...p, qty: Math.max(1, Math.min(999, Number(v || 1))) } : p))}
                                />
                              </div>
                            </div>

                            <div>
                              <div style={labelStyle}>Room name</div>
                              <Input value={posDraft.roomName} onChange={(v) => setPosDraft((p) => (p ? { ...p, roomName: v } : p))} />
                            </div>

                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                              <div>
                                <div style={labelStyle}>Position type</div>
                                <select
                                  value={posDraft.positionType}
                                  onChange={(e) => setPosDraft((p) => (p ? { ...p, positionType: e.target.value as any } : p))}
                                  style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                                >
                                  <option value="Window">Window</option>
                                  <option value="Door">Door</option>
                                </select>
                              </div>

                              <div style={{ display: "flex", alignItems: "center" }}>
                                <label style={{ display: "flex", alignItems: "center", gap: 8, fontSize: 14, fontWeight: 800 }}>
                                  <input
                                    type="checkbox"
                                    checked={posDraft.overrideDefaults}
                                    onChange={(e) => setPosDraft((p) => (p ? { ...p, overrideDefaults: e.target.checked } : p))}
                                  />
                                  Override defaults (per position)
                                </label>
                              </div>
                            </div>

                            {posDraft.overrideDefaults && (
                              <div style={{ borderRadius: 14, border: "1px solid #e4e4e7", padding: 12 }}>
                                <div style={{ fontWeight: 900, marginBottom: 10 }}>Supplier / Product override</div>
                                <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 12 }}>
                                  <div>
                                    <div style={labelStyle}>Supplier</div>
                                    <select
                                      value={posDraft.supplier}
                                      onChange={(e) => {
                                        const supplier = e.target.value;
                                        setPosDraft((p) =>
                                          p
                                            ? {
                                                ...p,
                                                supplier,
                                                product: supplier ? firstProductForSupplier(supplier) : "",
                                              }
                                            : p
                                        );
                                      }}
                                      style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                                    >
                                      <option value="">Select supplier…</option>
                                      {SUPPLIERS.map((s) => (
                                        <option key={s.name} value={s.name}>
                                          {s.name}
                                        </option>
                                      ))}
                                    </select>
                                  </div>

                                  <div>
                                    <div style={labelStyle}>Product type</div>
                                    <select
                                      value={posDraft.productType}
                                      onChange={(e) => setPosDraft((p) => (p ? { ...p, productType: e.target.value as any } : p))}
                                      style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                                    >
                                      {PRODUCT_TYPES.map((t) => (
                                        <option key={t} value={t}>
                                          {t}
                                        </option>
                                      ))}
                                    </select>
                                  </div>

                                  <div>
                                    <div style={labelStyle}>Product</div>
                                    <select
                                      value={posDraft.product}
                                      onChange={(e) => setPosDraft((p) => (p ? { ...p, product: e.target.value } : p))}
                                      disabled={!posDraft.supplier}
                                      style={{
                                        width: "100%",
                                        borderRadius: 12,
                                        border: "1px solid #e4e4e7",
                                        padding: "10px 12px",
                                        fontSize: 14,
                                        background: !posDraft.supplier ? "#fafafa" : "#fff",
                                        color: !posDraft.supplier ? "#a1a1aa" : "#18181b",
                                      }}
                                    >
                                      <option value="">{posDraft.supplier ? "Select product…" : "Select supplier first…"}</option>
                                      {allProductsForSupplier(posDraft.supplier).map((p) => (
                                        <option key={p} value={p}>
                                          {p}
                                        </option>
                                      ))}
                                    </select>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {posStep === 2 && (
                          <div style={{ display: "grid", gap: 12 }}>
                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                              <div>
                                <div style={labelStyle}>Total width (mm)</div>
                                <Input
                                  type="number"
                                  value={String(posDraft.widthMm)}
                                  onChange={(v) => setPosDraft((p) => (p ? { ...p, widthMm: parseNumberLoose(v, p.widthMm) } : p))}
                                />
                              </div>
                              <div>
                                <div style={labelStyle}>Total height (mm)</div>
                                <Input
                                  type="number"
                                  value={String(posDraft.heightMm)}
                                  onChange={(v) => setPosDraft((p) => (p ? { ...p, heightMm: parseNumberLoose(v, p.heightMm) } : p))}
                                />
                              </div>
                            </div>

                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                              <div>
                                <div style={labelStyle}>Fields (width)</div>
                                <Input
                                  type="number"
                                  value={String(posDraft.fieldsX)}
                                  onChange={(v) => setPosDraft((p) => (p ? { ...p, fieldsX: Math.max(1, Math.min(16, Number(v || 1))) } : p))}
                                />
                              </div>
                              <div>
                                <div style={labelStyle}>Fields (height)</div>
                                <Input
                                  type="number"
                                  value={String(posDraft.fieldsY)}
                                  onChange={(v) => setPosDraft((p) => (p ? { ...p, fieldsY: Math.max(1, Math.min(16, Number(v || 1))) } : p))}
                                />
                              </div>
                            </div>
                          </div>
                        )}

                        {posStep === 3 && (
                          <div style={{ display: "grid", gridTemplateColumns: "360px 1fr", gap: 16 }}>
                            <div style={{ display: "grid", gap: 12 }}>
                              <div style={{ borderRadius: 14, border: "1px solid #e4e4e7", padding: 12 }}>
                                <H3>Insertion</H3>
                                <div style={{ marginTop: 8 }}>
                                  <select
                                    value={posDraft.insertion}
                                    onChange={(e) => setPosDraft((p) => (p ? { ...p, insertion: e.target.value } : p))}
                                    style={{ width: "100%", borderRadius: 12, border: "1px solid #e4e4e7", padding: "10px 12px", fontSize: 14 }}
                                  >
                                    <option>Fixed</option>
                                    <option>Turn</option>
                                    <option>Tilt</option>
                                    <option>Tilt & Turn</option>
                                  </select>
                                </div>
                              </div>

                              {/* Grid editor (your provided component) */}
                              <div style={{ borderRadius: 14, border: "1px solid #e4e4e7", padding: 12 }}>
                                <H3>Grid editor</H3>
                                <div style={{ marginTop: 10 }}>
                                  <GridEditor pos={posDraft} setPos={setPosDraft as any} />
                                </div>
                              </div>
                            </div>

                            <div style={{ borderRadius: 14, border: "1px solid #e4e4e7", padding: 12 }}>
                              <H3>Summary</H3>
                              <div style={{ marginTop: 10, fontSize: 13, color: "#3f3f46", display: "grid", gap: 6 }}>
                                <div><b>Ref:</b> {posDraft.positionRef}</div>
                                <div><b>Room:</b> {posDraft.roomName || "—"}</div>
                                <div><b>Qty:</b> {posDraft.qty}</div>
                                <div><b>Supplier:</b> {posDraft.supplier || "—"}</div>
                                <div><b>Product type:</b> {posDraft.productType || "—"}</div>
                                <div><b>Product:</b> {posDraft.product || "—"}</div>
                                <div><b>Size:</b> {posDraft.widthMm}×{posDraft.heightMm}</div>
                                <div><b>Grid:</b> {posDraft.fieldsX}×{posDraft.fieldsY}</div>
                                <div><b>Insertion:</b> {posDraft.insertion}</div>
                              </div>

                              <div style={{ marginTop: 14, borderTop: "1px solid #e4e4e7", paddingTop: 12 }}>
                                <H3>Copy</H3>
                                <Small>(Placeholder) Copy options will be implemented next.</Small>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>

                      <div style={{ marginTop: 12, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                        <Button
                          variant="secondary"
                          onClick={() => setPosStep((s) => (s === 1 ? 1 : ((s - 1) as any)))}
                          disabled={posStep === 1}
                        >
                          Back
                        </Button>

                        {posStep < 3 ? (
                          <Button variant="primary" onClick={() => setPosStep((s) => ((s + 1) as any))}>
                            Next
                          </Button>
                        ) : (
                          <Button variant="primary" onClick={savePositionToEstimate}>
                            Save Position
                          </Button>
                        )}
                      </div>
                    </div>
                  )}
                </Card>
              )}
          </div>
        </div>
      </div>
    </div>
  );
}
